{% extends "layout.html" %}
{% block content %}
<!-- Progress bar -->
<div class="mb-4">
  <div class="d-flex justify-content-between mb-1">
    <small class="text-muted">Step 4 of 5</small>
    <small class="text-muted">NSTT Configuration</small>
  </div>
  <div class="progress">
    <div class="progress-bar" role="progressbar" style="width: 80%" aria-valuenow="80" aria-valuemin="0" aria-valuemax="100"></div>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h2 class="card-title mb-3"><i class="fa-solid fa-rocket me-1"></i> NSTT Configuration</h2>
    <p class="text-muted">
      If NSTT (Non-standard training tasks) is enabled this month, specify when training can begin,
      special Ops days, and who still needs to complete stages.
    </p>

    <form action="{{ url_for('nstt') }}" method="post" id="nsttForm">
      <div class="row g-3 mb-3">
        <!-- Global start -->
        <div class="col-md-4">
          <label for="nstt_global_start" class="form-label">Global NSTT start date (optional)</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fa-solid fa-calendar-check"></i></span>
            <input
              type="date"
              class="form-control"
              id="nstt_global_start"
              name="nstt_global_start"
              value="{{ existing_global_start }}"
            >
          </div>
        </div>

        <!-- 3-boarding -->
        <div class="col-md-4">
          <label for="nstt_three_boardings" class="form-label">3-boarding Ops days for NSTT</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fa-solid fa-flag"></i></span>
            <input
              type="text"
              class="form-control"
              id="nstt_three_boardings"
              name="nstt_three_boardings"
              placeholder="e.g. 3, 10-12"
              value="{{ existing_three_boardings }}"
            >
          </div>
        </div>

        <!-- 0-boarding -->
        <div class="col-md-4">
          <label for="nstt_no_boardings" class="form-label">0-boarding Ops days for NSTT</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fa-solid fa-flag-checkered"></i></span>
            <input
              type="text"
              class="form-control"
              id="nstt_no_boardings"
              name="nstt_no_boardings"
              placeholder="e.g. 5, 20-21"
              value="{{ existing_no_boardings }}"
            >
          </div>
        </div>
      </div>

      <!-- Count -->
      <div class="mb-3">
        <label for="nstt_num_members" class="form-label">How many participants need NSTT this month?</label>
        <div class="input-group">
          <span class="input-group-text"><i class="fa-solid fa-users"></i></span>
          <input
            type="number"
            class="form-control"
            id="nstt_num_members"
            name="nstt_num_members"
            min="0"
            value="{{ default_member_rows if default_member_rows is defined else 0 }}"
            required
          >
        </div>
      </div>

      <!-- Dynamic participant cards -->
      <div id="participants"></div>

      <div class="d-flex justify-content-between">
        <a href="{{ url_for('leaders') }}" class="btn btn-outline-secondary">
          <i class="fa-solid fa-arrow-left me-1"></i>Back
        </a>
        <button type="submit" class="btn btn-success">
          <i class="fa-solid fa-arrow-right me-1"></i>Next: Carryover
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Prefilled data from the server (safe, JSON-encoded)
  const existingMembers = {{ (existing_members or []) | tojson | safe }};
  const defaultRows = {{ (default_member_rows or 0) | int }};

  const numField = document.getElementById('nstt_num_members');
  const container = document.getElementById('participants');

  function renderParticipants() {
    const n = parseInt(numField.value || 0);
    container.innerHTML = '';

    for (let i = 1; i <= n; i++) {
      const m = existingMembers[i - 1] || {};
      const card = document.createElement('div');
      card.className = 'card mb-3';
      card.innerHTML = `
        <div class="card-body">
          <h5 class="card-title">NSTT Participant #${i}</h5>
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label" for="nstt_name_${i}">Name</label>
              <input type="text" class="form-control" id="nstt_name_${i}" name="nstt_name_${i}"
                     value="${m.name ? m.name : ''}" required>
            </div>
            <div class="col-md-3">
              <label class="form-label" for="nstt_types_${i}">Types (C2, E1 or C2,E1)</label>
              <input type="text" class="form-control" id="nstt_types_${i}" name="nstt_types_${i}"
                     placeholder="C2,E1" value="${m.types ? m.types : ''}" required>
            </div>
            <div class="col-md-3">
              <label class="form-label" for="nstt_c2_rem_${i}">C2 stages remaining (O,E,A)</label>
              <input type="text" class="form-control" id="nstt_c2_rem_${i}" name="nstt_c2_rem_${i}"
                     placeholder="e.g. O,E,A" value="${m.c2_rem ? m.c2_rem : ''}">
            </div>
            <div class="col-md-3">
              <label class="form-label" for="nstt_e1_rem_${i}">E1 stages remaining (O,E,A)</label>
              <input type="text" class="form-control" id="nstt_e1_rem_${i}" name="nstt_e1_rem_${i}"
                     placeholder="e.g. O,E,A" value="${m.e1_rem ? m.e1_rem : ''}">
            </div>
          </div>
          <div class="row g-3 mt-2">
            <div class="col-md-4">
              <label class="form-label" for="nstt_start_${i}">Personal start date (optional)</label>
              <input type="date" class="form-control" id="nstt_start_${i}" name="nstt_start_${i}"
                     value="${m.start ? m.start : ''}">
            </div>
          </div>
        </div>
      `;
      container.appendChild(card);
    }
  }

  // Initialize count and render on load
  if (!numField.value || parseInt(numField.value) === 0) {
    const initial = existingMembers.length > 0 ? existingMembers.length : (defaultRows || 0);
    numField.value = initial;
  }
  renderParticipants();

  // Re-render when user changes the count
  numField.addEventListener('input', renderParticipants);
</script>
{% endblock %}
