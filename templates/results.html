{% extends "layout.html" %}
{% block content %}

<h2 class="mb-2"><i class="fa-solid fa-chart-bar me-1"></i> Results Overview</h2>
<p class="text-muted">Use the tabs below to switch between the different views of your Ops plan.</p>

<!-- Tabs -->
<ul class="nav nav-tabs mb-3" id="resultsTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="ops-tab" data-bs-toggle="tab" data-bs-target="#ops-pane" type="button" role="tab" aria-controls="ops-pane" aria-selected="true">
      Ops Schedule
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="standby-tab" data-bs-toggle="tab" data-bs-target="#standby-pane" type="button" role="tab" aria-controls="standby-pane" aria-selected="false">
      Standby Schedule
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="nsf-tab" data-bs-toggle="tab" data-bs-target="#nsf-pane" type="button" role="tab" aria-controls="nsf-pane" aria-selected="false">
      NSF Summary
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="leader-tab" data-bs-toggle="tab" data-bs-target="#leader-pane" type="button" role="tab" aria-controls="leader-pane" aria-selected="false">
      Leader Summary
    </button>
  </li>
</ul>

<div class="tab-content" id="resultsTabsContent">

  <!-- OPS SCHEDULE -->
  <div class="tab-pane fade show active" id="ops-pane" role="tabpanel" aria-labelledby="ops-tab" tabindex="0">
    <div class="table-responsive">
      <table class="table table-bordered table-hover table-custom">
        <thead class="table-dark">
          <tr>
            <th class="gradient-th">Ops date (day)</th>
            <th class="gradient-th">TL</th>
            <th class="gradient-th">ATL</th>
            <th class="gradient-th">C2</th>
            <th class="gradient-th">NSFs</th>
          </tr>
        </thead>
        <tbody>
          {% if ops_rows and ops_rows|length %}
            {% for r in ops_rows %}
              {# r is a list: [date_str, TL, ATL, C2, NSFs] #}
              <tr>
                <td>
                  {% set day = r[0] %}
                  {% if '*' in day %}
                    <span class="badge rounded-pill text-bg-warning">{{ day|replace('*','') }}</span>
                  {% else %}
                    <span class="badge rounded-pill text-bg-light">{{ day }}</span>
                  {% endif %}
                </td>
                <td>{{ r[1] or "—" }}</td>
                <td>{{ r[2] or "—" }}</td>
                <td>{{ r[3] or "—" }}</td>
                <td>{{ r[4] or "—" }}</td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="5" class="text-muted">No rows to display.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- STANDBY -->
  <div class="tab-pane fade" id="standby-pane" role="tabpanel" aria-labelledby="standby-tab" tabindex="0">
    <div class="table-responsive">
      <table class="table table-bordered table-hover table-custom">
        <thead class="table-dark">
          <tr>
            <th class="gradient-th">Standby date (day)</th>
            <th class="gradient-th">TL</th>
            <th class="gradient-th">ATL</th>
            <th class="gradient-th">C2</th>
            <th class="gradient-th">NSFs</th>
          </tr>
        </thead>
        <tbody>
          {% if standby_rows and standby_rows|length %}
            {% for r in standby_rows %}
              {# r is a list: [date_str, TL, ATL, C2, NSFs] #}
              <tr>
                <td><span class="badge rounded-pill text-bg-light">{{ r[0] }}</span></td>
                <td>{{ r[1] or "—" }}</td>
                <td>{{ r[2] or "—" }}</td>
                <td>{{ r[3] or "—" }}</td>
                <td>{{ r[4] or "—" }}</td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="5" class="text-muted">No rows to display.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- NSF SUMMARY -->
  <div class="tab-pane fade" id="nsf-pane" role="tabpanel" aria-labelledby="nsf-tab" tabindex="0">
    <div class="table-responsive">
      <table class="table table-bordered table-hover table-custom">
        <thead class="table-dark">
          <tr>
            <th class="gradient-th">Name</th>
            <th class="gradient-th">Total Ops</th>
            <th class="gradient-th">Fri/Sat/3-boardings Ops</th>
            <th class="gradient-th">Carryover</th>
          </tr>
        </thead>
        <tbody>
          {% if nsf_summary_rows and nsf_summary_rows|length %}
            {% for r in nsf_summary_rows %}
              {# r is a list: [name, total/total_ops_count, bad, carry] #}
              <tr>
                <td>{{ r[0] }}</td>
                <td>{{ r[1] }}</td>
                <td>{{ r[2] }}</td>
                <td>{{ r[3] }}</td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="4" class="text-muted">No rows to display.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- LEADER SUMMARY -->
  <div class="tab-pane fade" id="leader-pane" role="tabpanel" aria-labelledby="leader-tab" tabindex="0">
    <div class="table-responsive">
      <table class="table table-bordered table-hover table-custom">
        <thead class="table-dark">
          <tr>
            <th class="gradient-th">Name</th>
            <th class="gradient-th">Role</th>
            <th class="gradient-th">Total Ops</th>
            <th class="gradient-th">Fri/Sat/3-boardings Ops</th>
          </tr>
        </thead>
        <tbody>
          {% if leader_summary_rows and leader_summary_rows|length %}
            {% for r in leader_summary_rows %}
              {# r is a list: [name, role, total/total_ops_count, bad] OR ["","","",""] spacer #}
              {% if (not r[0]) and (not r[1]) and (not r[2]) and (not r[3]) %}
                <tr class="spacer-row"><td colspan="4"></td></tr>
              {% else %}
                <tr>
                  <td>{{ r[0] }}</td>
                  <td>{{ r[1] }}</td>
                  <td>{{ r[2] }}</td>
                  <td>{{ r[3] }}</td>
                </tr>
              {% endif %}
            {% endfor %}
          {% else %}
            <tr><td colspan="4" class="text-muted">No rows to display.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Check if Bootstrap loaded correctly
  try {
    console.log('Bootstrap bundle present:', !!window.bootstrap);
    if (window.bootstrap && bootstrap.Tooltip) {
      console.log('Bootstrap version (from Tooltip):', bootstrap.Tooltip.VERSION);
    }
  } catch (e) { console.warn('Bootstrap check error:', e); }

  // Force tab activation on click
  const triggers = document.querySelectorAll('#resultsTabs [data-bs-toggle="tab"]');
  triggers.forEach(btn => {
    btn.addEventListener('click', function (e) {
      e.preventDefault();
      const tab = new bootstrap.Tab(this);
      tab.show();
    });
  });

  document.getElementById('resultsTabsContent')?.addEventListener('shown.bs.tab', (e) => {
    console.log('Tab shown:', e.target?.id);
  });
});
</script>
{% endblock %}

{% endblock %}
